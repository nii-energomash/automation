# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Resolve tag to ref
description: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ git-ref Ð¿Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð½Ð¾Ð¼Ñƒ git-Ñ‚ÐµÐ³Ñƒ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ñ‚ÐµÐ³Ñƒ)

inputs:
  tag:
    required: true
    description: Ð¢ÐµÐ³ Ð² Ñ„Ð¾Ð¼Ð°Ñ‚Ðµ v*.*.*

outputs:
  ref:
    value: ${{ steps.resolve.outputs.ref }}
    description: Resolved git-ref (refs/tags/...)

runs:
  using: composite
  steps:
    - name: ðŸ” Validate tag format
      uses: ./.github/actions/validate-tag-format
      with:
        tag: ${{ inputs.tag }}

    - name: âž¡ï¸ Resolve tag to ref
      id: resolve
      shell: bash
      run: |
        set -euo pipefail

        TAG="${{ inputs.tag }}"
        echo "ðŸ”Ž Input tag: $TAG"

        REF="refs/tags/$TAG"

        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ‚ÐµÐ³Ð° '$TAG'..."
        if ! git show-ref --verify "$REF" >/dev/null 2>&1; then
          echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ñ‚ÐµÐ³ '$TAG' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸"
          echo ""
          echo "Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ñ‚ÐµÐ³Ð¸:"
          git tag -l --sort=-version:refname "v*" | head -10
          echo ""
          exit 1
        fi

        echo "ref=${REF}" >> $GITHUB_OUTPUT
        echo "ðŸ“Œ Full ref: $REF"
