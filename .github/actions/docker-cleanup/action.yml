# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Docrer cleanup
description: >
  –£–¥–∞–ª–µ–Ω–∏–µ docker-–æ–±—Ä–∞–∑–æ–≤.
  –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –æ–±—Ä–∞–∑—ã, —Ç–µ–≥–∏ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 'sha-',
  –∏ –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–∞—Ä—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞/
  –¢—Ä–µ–±—É–µ—Ç—Å—è permissions.packages.write –∏ permissions.contents.read

inputs:
  days-old:
    required: true
    type: string
    default: "0"
    description: "–£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–∑—ã —Å—Ç–∞—Ä—à–µ —á–µ–º D –¥–Ω–µ–π"
  hours-old:
    required: true
    type: string
    default: "1"
    description: "–£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–∑—ã —Å—Ç–∞—Ä—à–µ —á–µ–º D –¥–Ω–µ–π –∏ H —á–∞—Å–æ–≤ (0‚Äì23)"
  show-only:
    required: false
    default: false
    type: boolean
    description: "–¢–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ (–Ω–µ —É–¥–∞–ª—è—Ç—å)"

runs:
  using: composite
  steps:
    - name: üßπ Docrer cleanup
      shell: bash
      run: |
        set -euo pipefail

        OWNER=${{ github.repository_owner }}
        REPO=${{ github.event.repository.name }}
        DAYS_OLD=${{ inputs.days-old || '0' }}
        HOURS_OLD=${{ inputs.hours-old || '1' }}
        SHOW_ONLY=${{ inputs.show-only || 'false' }}

        echo "Owner: ${OWNER}"
        echo "Repo:  ${REPO}"
        echo "Days old:  ${DAYS_OLD}"
        echo "Hours old: ${HOURS_OLD}"
        echo "Show only: ${SHOW_ONLY}"

        CUTOFF_TS=$(date -d "${DAYS_OLD} days ${HOURS_OLD} hours ago" +%s)
        echo "Cutoff timestamp: $CUTOFF_TS ($(date -d "@$CUTOFF_TS"))"

        echo "Fetching container versions‚Ä¶"

        gh api \
          /users/${OWNER}/packages/container/${REPO}/versions \
          --paginate \
          -q '
            .[] |
            select(.metadata.container.tags[]? | startswith("sha-")) |
            select((.updated_at | fromdateiso8601) < '"$CUTOFF_TS"') |
            {
              id: .id,
              updated_at: .updated_at,
              tags: .metadata.container.tags
            }
          ' |
        while read -r line; do
          ID=$(echo "$line" | jq -r '.id')
          TAGS=$(echo "$line" | jq -r '.tags | join(", ")')
          UPDATED=$(echo "$line" | jq -r '.updated_at')

          echo "‚Üí Found candidate:"
          echo "    id: $ID"
          echo "    tags: $TAGS"
          echo "    updated_at: $UPDATED"

          if [ "${SHOW_ONLY}" = "true" ]; then
            echo "    (dry-run, not deleting)"
          else
            echo "    Deleting version $ID"
            gh api \
              --method DELETE \
              /users/${OWNER}/packages/container/${REPO}/versions/$ID
          fi
        done
